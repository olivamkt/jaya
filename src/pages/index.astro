---
export const prerender = false

// Detect language preference from cookie first to keep user choice stable.
const cookie = Astro.request.headers.get('cookie') ?? ''
const match = cookie.match(/(?:^|;\s*)lang=(pt|en)(?:;|$)/)

// If cookie is set, redirect immediately to the matching locale path.
if (match?.[1]) {
	return Astro.redirect(`/${match[1]}/`, 307)
}

// Fall back to Accept-Language when no cookie is present.
const acceptLanguage = (Astro.request.headers.get('accept-language') ?? '').toLowerCase()
const prefersPt = acceptLanguage.includes('pt')
const lang = prefersPt ? 'pt' : 'en'

// Persist the decision in a cookie and use a non-permanent redirect.
return new Response(null, {
	status: 307,
	headers: {
		Location: `/${lang}/`,
		'Set-Cookie': `lang=${lang}; Path=/; Max-Age=31536000; SameSite=Lax; Secure`,
		Vary: 'Accept-Language'
	}
})
---
